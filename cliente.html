<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cliente - Mercado Express</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: Arial; margin: 0; background-color: #fff8dc; }
    header { background-color: #0084ff; color: white; text-align: center; padding: 10px; }
    nav button { padding: 10px; margin: 5px; background-color: #ffcc00; border: none; border-radius: 5px; }
    section { padding: 15px; }
    .btn { background-color: #28a745; color: white; padding: 10px; border: none; border-radius: 5px; margin: 5px; }
    #contador { font-size: 22px; color: #d32f2f; font-weight: bold; margin-top: 10px; }
    #map { height: 300px; margin-top: 10px; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“¦ Cliente - Mercado Express</h1>
</header>

<nav>
  <button onclick="vista('noti')">ğŸ”” Notificaciones</button>
  <button onclick="vista('mapa')">ğŸ—ºï¸ Ver paquete</button>
</nav>

<section id="noti">
  <h2>Â¿Recibir paquete ahora?</h2>
  <button class="btn" onclick="accion('ahora')">âœ… SÃ­</button>
  <button class="btn" onclick="accion('posponer')">ğŸ•“ Posponer</button>
  <br><br>
  <label>Lugar:</label><input type="text" placeholder="Ej. Calle 123"><br><br>
  <label>Hora:</label><input type="time"><br><br>
  <div id="contador"></div>
</section>

<section id="mapa" style="display:none;">
  <h2>Seguimiento en tiempo real</h2>
  <div id="map"></div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  function vista(v) {
    document.getElementById('noti').style.display = v === 'noti' ? 'block' : 'none';
    document.getElementById('mapa').style.display = v === 'mapa' ? 'block' : 'none';
    if (v === 'mapa') setTimeout(() => map.invalidateSize(), 300);
  }

  // SimulaciÃ³n mapa
  const map = L.map('map').setView([-51.6226, -69.2181], 14);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  
  // ğŸ“ Sucursal fija
const sucursal = L.marker([-51.6215, -69.2185], {
  icon: L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/128/1483/1483336.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  })
}).addTo(map).bindPopup('ğŸ¢ Sucursal Mercado Express');

// Marcador flotante para entrega (se crea dinÃ¡micamente)
let puntoEntrega;
  let puntoEntrega;
let rutaEntrega;


  const paquete = L.marker([-51.6226, -69.2181], {
    icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/128/833/833524.png', iconSize: [32,32], iconAnchor: [16,16] })
  }).addTo(map);

  // Movimiento simulado
  setInterval(() => {
    let pos = paquete.getLatLng();
    let dx = 0.0001, dy = -0.0001;
    paquete.setLatLng([pos.lat + dx, pos.lng + dy]);

    // Si llegÃ³ al destino, muestra notificaciÃ³n
    if (pos.lat < -51.621 && !window.notificado) {
      window.notificado = true;
      alert("ğŸ“¬ Tu paquete llegÃ³ a destino. Â¿QuerÃ©s recibirlo?");
    }
  }, 2000);

 function accion(tipo) {
  let mensaje = tipo === 'ahora'
    ? "ğŸ“ IngresÃ¡ calle y nÃºmero + horario de entrega (Ej: Av Roca 123 - 17:30)"
    : "ğŸ“ ReprogramaciÃ³n: IngresÃ¡ nueva calle y hora";

  let datos = prompt(mensaje);

  if (datos) {
    const minutos = tipo === 'ahora' ? 3 : 10;
    document.getElementById('contador').innerText = `â³ Tu paquete se entregarÃ¡ en ${minutos} minutos`;

    // SimulaciÃ³n de coordenadas segÃºn tipo
    let coordsEntrega = tipo === 'ahora'
      ? [-51.6205, -69.2175]
      : [-51.6212, -69.2160];

    // Si ya existe el marcador, quitarlo
    if (puntoEntrega) {
      map.removeLayer(puntoEntrega);
    }

    // Crear marcador nuevo de punto de entrega
    puntoEntrega = L.marker(coordsEntrega, {
      icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/128/684/684908.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      })
    }).addTo(map).bindPopup(`ğŸ“¦ Entrega programada:<br>${datos}`).openPopup();

    // ğŸ’œ Ruta entre sucursal y entrega
if (rutaEntrega) {
  map.removeLayer(rutaEntrega);
}

rutaEntrega = L.polyline([sucursal.getLatLng(), coordsEntrega], {
  color: 'violet',
  weight: 5,
  opacity: 0.9,
  dashArray: '8,5'
}).addTo(map);


    iniciarContador(minutos);
    map.setView(coordsEntrega, 15);
  }
}



  function iniciarContador(minutos) {
    let t = minutos * 60;
    let el = document.getElementById('contador');
    let i = setInterval(() => {
      let m = Math.floor(t/60), s = t%60;
      el.innerText = `â³ Falta ${m}:${s<10?'0'+s:s} para recibir tu paquete`;
      t--;
      if (t < 0) {
        clearInterval(i);
        el.innerText = 'ğŸ“¦ Entrega completada';
      }
    }, 1000);
  }
</script>

</body>
</html>

